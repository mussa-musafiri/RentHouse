<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RentHub Admin Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="shortcut icon" href="media/logo2.jpg" type="image/*">
<style>
/* ---------- BASIC STYLES ---------- */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
body { display:flex; min-height:100vh; background:#f5f7f9; color:#333; }
footer { text-align:center; padding:20px; background:#2c3e50; color:white; margin-top:20px; border-radius:10px; }

/* ---------- SIDEBAR ---------- */
.sidebar { width:250px; background:linear-gradient(135deg,#2c3e50,#4a6491); color:white; padding:30px 0; position:fixed; height:100vh; overflow-y:auto; display:flex; flex-direction:column; }
.sidebar-header { padding:0 25px 20px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:15px; }
.sidebar-header h3 { display:flex; align-items:center; gap:10px; font-weight:600; font-size:20px; }
.sidebar-header h3 i { color:#f1c40f; font-size:24px; }
.sidebar ul { list-style:none; padding:0; flex-grow:1; }
.sidebar ul li { padding:12px 25px; transition:0.3s; margin:5px 0; cursor:pointer; }
.sidebar ul li:hover { background: rgba(255,255,255,0.1); }
.sidebar ul li.active { background: rgba(255,255,255,0.15); border-left:4px solid #f1c40f; }
.sidebar ul li a { color:white; text-decoration:none; display:flex; align-items:center; gap:15px; font-weight: 550; }
.sidebar ul li a:hover { color:#f1c40f; }
.sidebar ul li a i { width:25px; font-size:18px; text-align:center; }

/* ---------- MAIN CONTENT ---------- */
.main-content { flex:1; padding:20px; margin-left:250px; width:calc(100% - 250px); overflow-y:auto; }
.header-wrapper { background:linear-gradient(135deg,#4a6491,#2c3e50); padding:20px; color:white; border-radius:10px; margin-bottom:25px; }
.header-wrapper h2 { font-weight:600; font-size:24px; }

/* ---------- CONTENT SECTIONS ---------- */
.content-section { display:none; margin-top:20px; }
.content-section.active { display:block; }

/* ---------- FORM STYLES ---------- */
.form-container { background:white; border-radius:12px; padding:25px; box-shadow:0 4px 10px rgba(0,0,0,0.08); margin-bottom:30px; }
.form-row { display:flex; flex-wrap:wrap; margin:0 -10px; }
.form-group { flex:1 0 calc(50% - 20px); margin:0 10px 20px; min-width:250px; }
.form-group label { display:block; font-weight:500; margin-bottom:8px; color:#2c3e50; font-size:15px; }
.form-group input, .form-group textarea { width:100%; padding:14px; border:1px solid #ddd; border-radius:8px; font-size:15px; transition:0.3s; }
.form-group input:focus, .form-group textarea:focus { outline:none; border-color:#4a6491; box-shadow:0 0 0 3px rgba(74,100,145,0.2); }
.form-group textarea { min-height:120px; resize:vertical; }
.file-input-container { position:relative; display:flex; align-items:center; padding:14px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9; }
.file-input-container input[type="file"] { position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer; }
.file-input-button { background:#4a6491; color:white; padding:8px 12px; border-radius:6px; display:inline-flex; align-items:center; gap:8px; margin-right:12px; }
.file-input-text { color:#7f8c8d; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.submit-btn { background:linear-gradient(135deg,#4a6491,#2c3e50); color:white; border:none; padding:16px 30px; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; display:block; margin:20px auto 0; width:200px; }
.submit-btn:hover { background:linear-gradient(135deg,#2c3e50,#4a6491); transform:translateY(-2px); }

/* ---------- MEDIA PREVIEWS ---------- */
.media-previews { display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; }
.media-preview { width:300px; border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#f9f9f9; }
.media-preview h4 { background:#4a6491; color:white; padding:10px; margin:0; font-size:16px; }
.preview-content { padding:15px; text-align:center; }
.image-preview, .video-preview { max-width:100%; border-radius:4px; display:none; }
.no-preview { color:#7f8c8d; font-style:italic; padding:30px 0; text-align:center; }

/* ---------- PROPERTY CARDS ---------- */
.property-card { background:#fff; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); overflow:hidden; width:320px; display:flex; flex-direction:column; margin-bottom:20px; }
.property-card:hover { transform:translateY(-6px); box-shadow:0 8px 20px rgba(0,0,0,0.12); }
.property-image { width:100%; height:200px; object-fit:cover; border-bottom:2px solid #f0f0f0; }
.property-details { padding:20px; display:flex; flex-direction:column; gap:10px; }
.property-details h3 { margin:0; font-size:20px; color:#2c3e50; font-weight:600; }
.property-details .property-location { font-size:14px; color:#7f8c8d; }
.property-details .property-price { font-size:18px; font-weight:bold; color:#27ae60; }
.property-details .property-description { font-size:14px; color:#555; line-height:1.5; }
.property-details .property-owner { font-size:14px; color:#444; margin-top:10px; padding-top:10px; border-top:1px solid #eee; }
.property-actions { display:flex; justify-content:center; margin-top:15px; gap:10px; }
.edit-btn { background:linear-gradient(135deg,#27ae60,#219653); color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:8px; }
.edit-btn:hover { background:linear-gradient(135deg,#219653,#1e8449); transform:translateY(-2px); }
.delete-btn { background:linear-gradient(135deg,#e74c3c,#c0392b); color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:8px; }
.delete-btn:hover { background:linear-gradient(135deg,#c0392b,#a93226); transform:translateY(-2px); }
#user-section table {width: 100%;border-collapse: collapse;margin-top: 15px;background: #fff;border-radius: 12px;overflow: hidden;box-shadow: 0 4px 12px rgba(0,0,0,0.08);}
#user-section table th, #user-section table td {padding: 15px 20px;text-align: left;font-size: 15px;}
#user-section table th {background: #4a6491;color: white;font-weight: 600;}
#user-section table tr:nth-child(even) {background: #f5f7f9;}
#user-section table tr:hover {background: #dbe3f0;transition: 0.3s;}
.refresh-btn {background: linear-gradient(135deg,#4a6491,#2c3e50);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;margin-bottom:15px;}
.refresh-btn:hover {background: linear-gradient(135deg,#2c3e50,#4a6491);transform: translateY(-2px);}
.property-card {transition: transform 0.3s, box-shadow 0.3s;}
.property-card:hover {transform: translateY(-8px);box-shadow: 0 12px 20px rgba(0,0,0,0.15);}
.property-details h3 {font-size: 20px;color: #2c3e50;}
.property-details .property-location {font-size: 14px;color: #7f8c8d;}
.property-details .property-price {
  font-size: 18px;
  font-weight: bold;
  color: #27ae60;
}

.property-actions button {
  font-size: 14px;
  font-weight: 600;
}

/* ---------- MEDIA PREVIEW CARD ---------- */
.media-preview {
  flex:1 1 300px;
  min-width: 250px;
}
.media-preview h4 {
  font-size: 16px;
  background: #4a6491;
  color: white;
  padding: 10px;
  margin:0;
}
.preview-content {
  padding:15px;
  text-align:center;
  border:1px solid #ddd;
  border-top:none;
  border-radius:0 0 8px 8px;
  background:#f9f9f9;
}

/* ---------- FORM INPUTS ---------- */
.form-container input, .form-container textarea {
  font-size: 15px;
  border-radius: 8px;
  padding: 12px 15px;
  border:1px solid #ccc;
  transition: 0.3s;
}

.form-container input:focus, .form-container textarea:focus {
  border-color: #4a6491;
  box-shadow: 0 0 0 3px rgba(74,100,145,0.2);
}

/* ---------- RESPONSIVE ---------- */
/* ---------- TABLET: 1024px and below ---------- */
@media screen and (max-width: 1024px) {
  .sidebar {
    width: 200px;
  }
  .main-content {
    margin-left: 200px;
    width: calc(100% - 200px);
  }
  .form-row {
    flex-wrap: wrap;
  }
  .media-previews {
    flex-wrap: wrap;
    gap: 15px;
  }
  .property-card {
    width: 280px;
  }
}

/* ---------- MOBILE: 768px and below ---------- */
/* ---------- MOBILE: 700px and below ---------- */
@media screen and (max-width: 700px) {
  /* Sidebar becomes horizontal top nav */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    flex-direction: row;
    justify-content: space-around;
    align-items: center;
    padding: 0;
    z-index: 1000;
    border-bottom: 1px solid #ddd;
  }

  /* Hide sidebar header text */
  .sidebar-header {
    display: none;
  }

  /* Menu links as horizontal items */
  .sidebar ul {
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    width: 100%;
    padding: 0;
  }

  .sidebar ul li {
    margin: 0;
    padding: 0;
    flex: 1;
    text-align: center;
  }

  .sidebar ul li a {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0;
    padding: 8px 0;
  }

  .sidebar ul li a i {
    font-size: 20px;
  }

  /* Main content pushed below the navbar */
  .main-content {
    margin-left: 0;
    margin-top: 60px;
    width: 100%;
  }
}
@media screen and (max-width: 768px) {
  /* Sidebar becomes horizontal top nav */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    flex-direction: row;
    justify-content: space-around;
    align-items: center;
    padding: 0;
    z-index: 1000;
    border-bottom: 1px solid #ddd;
  }

  /* Hide sidebar header text */
  .sidebar-header {
    display: none;
  }

  /* Menu links as horizontal items */
  .sidebar ul {
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    width: 100%;
    padding: 0;
  }

  .sidebar ul li {
    margin: 0;
    padding: 0;
    flex: 1;
    text-align: center;
  }

  .sidebar ul li a {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0;
    padding: 8px 0;
  }

  .sidebar ul li a i {
    font-size: 20px;
  }

  /* Main content pushed below the navbar */
  .main-content {
    margin-left: 0;
    margin-top: 60px;
    width: 100%;
  }
}


</style>
</head>
<body>
<!-- ------------------ SIDEBAR ------------------ -->
<div class="sidebar">
  <div class="sidebar-header">
    <h3><i class="fas fa-home"></i> RentHub Admin</h3>
  </div>
  <ul class="menu">
    <li class="active"><a href="#" data-section="add-house-section"><i class="fas fa-plus-circle" style="color:lightsalmon"></i> Add House</a></li>
    <li><a href="#" data-section="all-properties-section"><i class="fas fa-building" style="color:gold"></i> Manage Properties</a></li>
    <li><a href="#" data-section="selected-properties-section"><i class="fas fa-star" style="color:lightgreen"></i> Selected Houses</a></li>
    <li><a href="#" data-section="user-section"><i class="fas fa-users" style="color:lightblue"></i> View Users</a></li>
    <li><a href="index.html"><i class="fas fa-arrow-left" style="color:pink"></i> Back Home</a></li>
  </ul>
</div>

<!-- ------------------ MAIN CONTENT ------------------ -->
<div class="main-content">
  <div class="header-wrapper"><h2>Admin Dashboard - House Rental Management</h2></div>

  <!-- Add House Section -->
  <div class="content-section active" id="add-house-section">
    <h2><i class="fas fa-plus-circle"></i> Add New House</h2><br>
    <form id="addHouseForm" class="form-container">
      <div class="form-row">
        <div class="form-group"><label>Property Title</label><input type="text" id="houseTitle" required placeholder="Beautiful family home"></div>
        <div class="form-group"><label>Price (RWF)</label><input type="number" id="housePrice" required placeholder="25000000"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Location</label><input type="text" id="houseLocation" required placeholder="Kigali, Rwanda"></div>
        <div class="form-group"><label>Owner Name</label><input type="text" id="houseOwner" required placeholder="John Doe"></div>
      </div>
      <div class="form-group"><label>Description</label><textarea id="houseDescription" required placeholder="Describe the property features, amenities, and surroundings..."></textarea></div>
      <div class="form-row">
        <div class="form-group"><label>Image</label>
          <div class="file-input-container">
            <div class="file-input-button"><i class="fas fa-upload"></i> Choose</div>
            <div class="file-input-text" id="imageFileName">No image</div>
            <input type="file" id="houseImage" accept="image/*">
          </div>
        </div>
        <div class="form-group"><label>Video</label>
          <div class="file-input-container">
            <div class="file-input-button"><i class="fas fa-upload"></i> Choose</div>
            <div class="file-input-text" id="videoFileName">No video</div>
            <input type="file" id="houseVideo" accept="video/*">
          </div>
        </div>
      </div>
      <div class="form-group"><label>Phone Number</label><input type="tel" id="housePhone" required placeholder="+250 78X XXX XXX"></div>
      <div class="media-previews">
        <div class="media-preview"><h4>Image Preview</h4><div class="preview-content"><img id="imagePreview" class="image-preview"><div id="noImagePreview" class="no-preview">No image</div></div></div>
        <div class="media-preview"><h4>Video Preview</h4><div class="preview-content"><video id="videoPreview" class="video-preview" controls></video><div id="noVideoPreview" class="no-preview">No video</div></div></div>
      </div>
      <button type="submit" class="submit-btn">Add House</button>
    </form>
  </div>

  <!-- All Properties Section -->
  <div class="content-section" id="all-properties-section">
    <button class="submit-btn" onclick="renderProperties()">Refresh Properties</button>
    <div id="allProperties"></div>
  </div>

  <!-- Selected Properties Section -->
  <div class="content-section" id="selected-properties-section">
    <button class="submit-btn" onclick="renderSelectedProperties()">Refresh Selected</button>
    <div id="selectedProperties"></div>
  </div>

  <!-- Users Section -->
  <div class="content-section" id="user-section">
    <button class="submit-btn" onclick="renderUsers()">Refresh Users</button>
    <table border="1" width="100%" style="margin-top:10px; border-collapse:collapse;">
      <thead><tr><th>Name</th><th>Phone</th></tr></thead>
      <tbody id="usersTableBody"></tbody>
    </table>
  </div>

  <footer>&copy; 2025 RentHub. All rights reserved.</footer>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://wnxhkgfgllgnegsataml.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndueGhrZ2ZnbGxnbmVnc2F0YW1sIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODE2ODYzOSwiZXhwIjoyMDczNzQ0NjM5fQ.bAqRDpDvS43ceYM04iKZT3BYkdtipnPwSAKJVqif0-8';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentEditId = null;

// ---------- SIDEBAR NAVIGATION ----------
document.querySelectorAll('.sidebar ul li a[data-section]').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    const sectionId = link.getAttribute('data-section');
    showSection(sectionId);
    setActiveMenuItem(link);
  });
});

function showSection(id){
  document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
  const section = document.getElementById(id);
  if(section) section.classList.add('active');
  if(id==='all-properties-section') renderProperties();
  if(id==='selected-properties-section') renderSelectedProperties();
  if(id==='user-section') renderUsers();
}

function setActiveMenuItem(element){
  document.querySelectorAll('.sidebar ul li').forEach(li => li.classList.remove('active'));
  element.parentElement.classList.add('active');
}

// ---------- IMAGE & VIDEO PREVIEWS ----------
document.getElementById('houseImage').addEventListener('change', e=>{
  const file=e.target.files[0];
  const preview=document.getElementById('imagePreview');
  const noPreview=document.getElementById('noImagePreview');
  if(file){
    preview.src=URL.createObjectURL(file);
    preview.style.display='block';
    noPreview.style.display='none';
  } else {
    preview.src=''; preview.style.display='none'; noPreview.style.display='block';
  }
  document.getElementById('imageFileName').textContent=file?file.name:'No image';
});

document.getElementById('houseVideo').addEventListener('change', e=>{
  const file=e.target.files[0];
  const preview=document.getElementById('videoPreview');
  const noPreview=document.getElementById('noVideoPreview');
  if(file){
    preview.src=URL.createObjectURL(file);
    preview.style.display='block';
    noPreview.style.display='none';
  } else {
    preview.src=''; preview.style.display='none'; noPreview.style.display='block';
  }
  document.getElementById('videoFileName').textContent=file?file.name:'No video';
});

function resetPreviews(){
  document.getElementById('imagePreview').src=''; document.getElementById('imagePreview').style.display='none';
  document.getElementById('noImagePreview').style.display='block'; document.getElementById('imageFileName').textContent='No image';
  document.getElementById('videoPreview').src=''; document.getElementById('videoPreview').style.display='none';
  document.getElementById('noVideoPreview').style.display='block'; document.getElementById('videoFileName').textContent='No video';
}

// ---------- ADD/UPDATE HOUSE ----------
document.getElementById('addHouseForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const btn=e.target.querySelector('button[type="submit"]');
  btn.disabled=true; btn.textContent=currentEditId?'Updating...':'Processing...';

  const title=document.getElementById('houseTitle').value;
  const price=document.getElementById('housePrice').value;
  const location=document.getElementById('houseLocation').value;
  const owner=document.getElementById('houseOwner').value;
  const description=document.getElementById('houseDescription').value;
  const phone=document.getElementById('housePhone').value;

  let imagePath=null, videoPath=null;
  const imageFile=document.getElementById('houseImage').files[0];
  const videoFile=document.getElementById('houseVideo').files[0];

  if(imageFile){
    const {data,error}=await supabase.storage.from('property-media').upload(`images/${Date.now()}-${imageFile.name}`,imageFile);
    if(error){alert(error.message); btn.disabled=false; btn.textContent=currentEditId?'Update House':'Add House'; return;}
    imagePath=data.path;
  }

  if(videoFile){
    const {data,error}=await supabase.storage.from('property-media').upload(`videos/${Date.now()}-${videoFile.name}`,videoFile);
    if(error){alert(error.message); btn.disabled=false; btn.textContent=currentEditId?'Update House':'Add House'; return;}
    videoPath=data.path;
  }

  if(currentEditId){
    const {error}=await supabase.from('properties').update({
      title, price, location, owner_name:owner, description, phone,
      image_path:imagePath, video_path:videoPath, updated_at:new Date().toISOString()
    }).eq('id',currentEditId);

    if(error){alert(error.message); btn.disabled=false; return;}
    alert('House updated successfully!');
    currentEditId=null;
    btn.textContent='Add House';
  } else {
    const {error}=await supabase.from('properties').insert([{
      title, price, location, owner_name:owner, description, phone, image_path:imagePath, video_path:videoPath
    }]);
    if(error){alert(error.message); btn.disabled=false; return;}
    alert('House added successfully!');
  }

  e.target.reset(); resetPreviews(); btn.disabled=false;
});

// ---------- RENDER PROPERTIES ----------
async function renderProperties(){
  const {data,error}=await supabase.from('properties').select('*').order('created_at',{ascending:false});
  const container=document.getElementById('allProperties'); container.innerHTML='';
  if(error){container.innerHTML=`Error: ${error.message}`; return;}
  if(!data.length){container.innerHTML='<p>No properties found.</p>'; return;}

  data.forEach(p=>{
    const div=document.createElement('div'); div.className='property-card';
    const imageUrl=p.image_path?supabase.storage.from('property-media').getPublicUrl(p.image_path).data.publicUrl:'https://via.placeholder.com/320x200';
    const videoUrl=p.video_path?supabase.storage.from('property-media').getPublicUrl(p.video_path).data.publicUrl:null;

    div.innerHTML=`
      <img src="${imageUrl}" class="property-image">
      <div class="property-details">
        <h3>${p.title}</h3>
        <div class="property-location">${p.location}</div>
        <div class="property-price">RWF ${p.price}</div>
        <div class="property-description">${p.description}</div>
        <div class="property-owner">Owner: ${p.owner_name}<br>Phone: ${p.phone}</div>
        ${videoUrl?`<video class="video-preview" controls src="${videoUrl}" style="margin-top:10px; max-width:100%; border-radius:6px;"></video>`:''}
        <div class="property-actions">
          <button class="edit-btn" onclick="editProperty('${p.id}')">Edit</button>
          <button class="delete-btn" onclick="deleteProperty('${p.id}')">Delete</button>
        </div>
      </div>`;
    container.appendChild(div);
  });
}

// ---------- EDIT & DELETE ----------
window.deleteProperty=async id=>{
  if(!confirm('Are you sure?')) return;
  const {error}=await supabase.from('properties').delete().eq('id',id);
  if(error){alert(error.message); return;}
  renderProperties();
};

window.editProperty=async id=>{
  const {data:house,error}=await supabase.from('properties').select('*').eq('id',id).single();
  if(error){alert(error.message); return;}

  showSection('add-house-section'); currentEditId=id;

  document.getElementById('houseTitle').value=house.title;
  document.getElementById('housePrice').value=house.price;
  document.getElementById('houseLocation').value=house.location;
  document.getElementById('houseOwner').value=house.owner_name;
  document.getElementById('houseDescription').value=house.description;
  document.getElementById('housePhone').value=house.phone;

  if(house.image_path){
    const img=document.getElementById('imagePreview');
    img.src=supabase.storage.from('property-media').getPublicUrl(house.image_path).data.publicUrl;
    img.style.display='block';
    document.getElementById('noImagePreview').style.display='none';
    document.getElementById('imageFileName').textContent=house.image_path.split('/').pop();
  }

  if(house.video_path){
    const vid=document.getElementById('videoPreview');
    vid.src=supabase.storage.from('property-media').getPublicUrl(house.video_path).data.publicUrl;
    vid.style.display='block';
    document.getElementById('noVideoPreview').style.display='none';
    document.getElementById('videoFileName').textContent=house.video_path.split('/').pop();
  }

  document.querySelector('#addHouseForm button[type="submit"]').textContent='Update House';
};

// ---------- SELECTED PROPERTIES ----------
// ---------- SELECTED PROPERTIES ----------
async function renderSelectedProperties() {
  // Fetch selected properties with related property and user data
  const { data, error } = await supabase
    .from('selected_properties')
    .select(`
      id,
      selected_at,
      properties:property_id(*),
      site_users:selected_by(id, full_name, phone)
    `)
    .order('selected_at', { ascending: false });

  const container = document.getElementById('selectedProperties');
  container.innerHTML = '';

  if (error) {
    container.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
    return;
  }

  if (!data.length) {
    container.innerHTML = '<p>No selected properties.</p>';
    return;
  }

  data.forEach(sel => {
    const p = sel.properties;
    const user = sel.site_users;

    const div = document.createElement('div');
    div.className = 'property-card';

    const imageUrl = p.image_path
      ? supabase.storage.from('property-media').getPublicUrl(p.image_path).data.publicUrl
      : 'https://via.placeholder.com/320x200';

    const videoUrl = p.video_path
      ? supabase.storage.from('property-media').getPublicUrl(p.video_path).data.publicUrl
      : null;

    div.innerHTML = `
      <img src="${imageUrl}" class="property-image">
      <div class="property-details">
        <h3>${p.title}</h3>
        <div class="property-location">${p.location}</div>
        <div class="property-price">RWF ${p.price}</div>
        <div class="property-description">${p.description}</div>
        ${videoUrl ? `<video class="video-preview" controls src="${videoUrl}" style="margin-top:10px; max-width:100%; border-radius:6px;"></video>` : ''}
        <div class="property-owner">
          <strong>Selected By:</strong> ${user?.full_name ?? 'Guest'}<br>
          ${user?.phone ? `Phone: ${user.phone}` : ''}
          <br><em>At: ${new Date(sel.selected_at).toLocaleString()}</em>
        </div>
      </div>
    `;

    container.appendChild(div);
  });
}

// ---------- USERS ----------
async function renderUsers() {
  const { data, error } = await supabase.from('site_users').select('*');
  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = '';
  if (error) { tbody.innerHTML = `<tr><td colspan="2">${error.message}</td></tr>`; return; }
  if (!data.length) { tbody.innerHTML = '<tr><td colspan="2">No users found</td></tr>'; return; }
  data.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.full_name ?? ''}</td><td>${u.phone ?? ''}</td>`;
    tbody.appendChild(tr);
  });
}
// ---------- INITIAL LOAD ----------
renderProperties();
renderSelectedProperties();
renderUsers();


</script>
</body>
</html>
